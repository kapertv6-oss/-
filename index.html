<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>HAKKA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- СТИЛИ НЕ ТРОНУТЫ -->
</head>

<body>
<div class="app">

<!-- МЕНЮ -->
<div id="menu" class="screen active">
  <h1 class="title">HAKKA</h1>
  <button onclick="openProfile()">Профиль</button>
  <button onclick="openCharacters()">Персонажи</button>
  <button onclick="openWorkshop()">Мастерская</button>
</div>

<!-- МАСТЕРСКАЯ -->
<div id="workshop" class="screen">
  <h1 class="title">Создание персонажа</h1>

  <input id="charName" placeholder="Имя персонажа">
  <textarea id="charDesc" placeholder="Описание"></textarea>
  <input id="charAvatar" placeholder="URL аватара">

  <button onclick="createCharacter()">Создать</button>
  <button onclick="goMenu()">Назад</button>
</div>

<!-- ЧАТ -->
<div id="chat" class="screen">
  <h1 class="title" id="chatTitle"></h1>
  <div id="chatWindow" class="characters-wrapper"></div>
  <input id="userMessage" placeholder="Сообщение">
  <button onclick="sendMessage()">Отправить</button>
  <button onclick="goCharacters()">Назад</button>
</div>

</div>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const API = "https://ТВОЙ-ДОМЕН";

const profile = JSON.parse(localStorage.getItem("hakkaProfile"))
  || { nick: "Игрок", tokens: 100 };

let activeChar = null;

// ---------- МАСТЕРСКАЯ ----------

function createCharacter(){
  fetch(API + "/character/create", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      user: profile.nick,
      name: charName.value,
      description: charDesc.value,
      avatar: charAvatar.value
    })
  }).then(()=>alert("Персонаж создан!"));
}

// ---------- ЧАТ ----------

function openChat(name){
  activeChar = name;
  showScreen("chat");
  chatTitle.textContent = "Чат с " + name;
  loadChat();
}

function sendMessage(){
  const msg = userMessage.value.trim();
  if(!msg) return;

  addMsg("user", msg);
  saveMsg("user", msg);

  fetch(API + "/ask", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ message: msg, character: activeChar })
  })
  .then(r=>r.json())
  .then(d=>{
    addMsg("bot", d.answer);
    saveMsg("bot", d.answer);
  });

  userMessage.value = "";
}

function addMsg(type, text){
  const div = document.createElement("div");
  div.className = "chat-message " + (type==="user"?"user-msg":"bot-msg");
  div.textContent = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function saveMsg(sender, msg){
  fetch(API + "/chat/save", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      user: profile.nick,
      character: activeChar,
      sender,
      message: msg
    })
  });
}

function loadChat(){
  fetch(`${API}/chat/load?user=${profile.nick}&character=${activeChar}`)
    .then(r=>r.json())
    .then(list=>{
      chatWindow.innerHTML="";
      list.forEach(m=>addMsg(m.sender, m.msg));
    });
}

// ---------- UI ----------

function openWorkshop(){ showScreen("workshop"); }
function goMenu(){ showScreen("menu"); }
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}
</script>
</body>
</html>
