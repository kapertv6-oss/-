<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hakka AI</title>
<style>
:root {--bg:#140c12;--accent:#ff4d6d;--panel:rgba(255,255,255,.05);}
*{box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
body{margin:0;background:var(--bg);color:#fff;overflow:hidden;}
#loader{position:fixed;top:0;left:0;width:100%;height:100%;background:#140c12;display:flex;align-items:center;justify-content:center;color:#fff;font-size:28px;font-weight:bold;z-index:1000;}
#notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(255,77,109,0.9);padding:12px 20px;border-radius:12px;display:none;color:#fff;font-weight:bold;z-index:999;}
.sparkle{position:fixed;border-radius:50%;pointer-events:none;background:var(--accent);}
.app{position:relative;z-index:2;height:100vh;display:flex;flex-direction:column;}
header{padding:14px;text-align:center;font-size:22px;font-weight:bold;color:var(--accent);}
.screen{flex:1;display:none;padding:15px;overflow-y:auto;}
.screen.active{display:block;}
.card{background:var(--panel);padding:16px;border-radius:16px;margin-bottom:12px;transition:transform .2s;}
.card:hover{transform:scale(1.02);}
button{min-width:100px;padding:10px 14px;border-radius:12px;border:none;background:var(--accent);color:#fff;font-size:14px;font-weight:500;cursor:pointer;transition:transform .15s,opacity .15s;}
button:hover{transform:scale(1.04);opacity:.95;}
button:active{transform:scale(0.98);}
.chat{display:flex;flex-direction:column;}
.msg{max-width:80%;padding:10px 14px;border-radius:14px;margin-bottom:10px;animation:fade .3s ease;display:flex;align-items:flex-end;}
.msg .avatar{width:30px;height:30px;border-radius:50%;background-size:cover;display:flex;align-items:center;justify-content:center;font-size:20px;}
.user{background:#2a2a2a;margin-left:auto;}
.user .avatar{margin-left:12px;margin-right:0;}
.bot{background:rgba(255,77,109,.15);border:1px solid var(--accent);}
.bot .avatar{margin-right:12px;}
.typing{opacity:.6;font-style:italic;}
.input{display:flex;gap:8px;margin-top:10px;}
input{flex:1;padding:12px;border-radius:12px;border:none;outline:none;}
@keyframes fade{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>
<div id="loader">Hakka AI –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
<div id="notification"></div>

<div class="app">
<header id="header">Hakka AI</header>

<!-- –ú–ï–ù–Æ -->
<div class="screen active" id="menu">
  <div class="card"><button onclick="show('characters')">üé≠ –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</button></div>
  <div class="card"><button onclick="show('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button></div>
  <div class="card"><button onclick="show('workshop')">üõ† –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è</button></div>
</div>

<!-- –ü–ï–†–°–û–ù–ê–ñ–ò -->
<div class="screen" id="characters">
  <div class="card" onclick="openChat('–†–∏–∞—Å')">‚ù§Ô∏è –†–∏–∞—Å –ì—Ä–µ–º–æ—Ä–∏</div>
  <div class="card" onclick="openChat('–ö–æ–Ω—ç–∫–æ')">‚ùÑÔ∏è –ö–æ–Ω—ç–∫–æ –¢–æ–¥–∑—ë</div>
  <div class="card" onclick="openUserChar()">‚ú® –ú–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂</div>
  <button onclick="show('menu')">‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<!-- –ü–†–û–§–ò–õ–¨ -->
<div class="screen" id="profile">
  <div class="card" id="profileContent"></div>
  <div class="card">
    <input id="promoInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥">
    <button onclick="applyPromo()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>
</div>

<!-- –ß–ê–¢ -->
<div class="screen" id="chatScreen">
  <div class="chat" id="chat"></div>
  <div class="input">
    <input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
    <button onclick="send()">‚ñ∂</button>
  </div>
  <button onclick="show('characters')">‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<!-- –ú–ê–°–¢–ï–†–°–ö–ê–Ø -->
<div class="screen" id="workshop">
  <h2>üõ† –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è</h2>
  <div class="card">
    <input id="charName" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
    <input id="charMood" placeholder="–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ/–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞">
    <input id="charAvatar" placeholder="–ê–≤–∞—Ç–∞—Ä (URL)">
    <button onclick="createCharacter()">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (100 Retokens)</button>

    <div class="preview" style="margin-top:12px;padding:10px;background:rgba(255,255,255,0.05);border-radius:12px;display:flex;align-items:center;gap:10px;">
      <div id="previewAvatar" style="width:50px;height:50px;border-radius:50%;background-size:cover;"></div>
      <div>
        <div id="previewName" style="font-weight:bold;">–ò–º—è</div>
        <div id="previewMood" style="opacity:0.7;font-size:14px;">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
      </div>
    </div>

  </div>
  <button onclick="show('menu')">‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

</div>

<script>
window.addEventListener('load',()=>{
  const loader=document.getElementById('loader');
  loader.style.transition='opacity 0.6s';
  loader.style.opacity=0;
  setTimeout(()=>loader.remove(),600);
});

/* ===== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ ===== */
let userNick = localStorage.getItem('nick') || '–¢—ã';
let currentChar = '–†–∏–∞—Å';

/* ===== TG –î–ê–ù–ù–´–ï ===== */
let tgUser = {id:'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',username:userNick,first_name:'–¢—ã',photo_url:'https://i.imgur.com/default_user.png'};
if(window.Telegram?.WebApp?.initDataUnsafe?.user){
  const u = window.Telegram.WebApp.initDataUnsafe.user;
  tgUser.id = u.id;
  tgUser.username = u.username || userNick;
  tgUser.first_name = u.first_name || userNick;
  if(u.photo_url) tgUser.photo_url = u.photo_url;
}

/* ===== –ü–†–û–§–ò–õ–¨ ===== */
function updateProfile(){
  let coins = parseInt(localStorage.getItem('coins')) || 100;
  document.getElementById('coins')?.remove();
  document.getElementById('profileContent').innerHTML=`
    <div class="card">TG Nick: <b>${tgUser.username}</b></div>
    <div class="card">TG ID: <b>${tgUser.id}</b></div>
    <div class="card">–ê–≤–∞—Ç–∞—Ä–∫–∞:</div>
    <div class="card"><img src="${tgUser.photo_url}" style="width:50px;border-radius:50%"></div>
    <div class="card">Retokens: <b id="coins">${coins}</b></div>
    <div class="card">
      <input id="nickInput" placeholder="–ù–∏–∫ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π">
      <button onclick="saveNick()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫</button>
    </div>
  `;
}

/* ===== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===== */
function notify(text,time=2000){
  const n=document.getElementById('notification');
  n.textContent=text;
  n.style.display='block';
  setTimeout(()=>{n.style.display='none';},time);
}

/* ===== –ù–ê–í–ò–ì–ê–¶–ò–Ø ===== */
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='profile') updateProfile();
}

/* ===== –°–û–•–†–ê–ù–ï–ù–ò–ï –ù–ò–ö–ê ===== */
function saveNick(){
  const v=document.getElementById('nickInput').value.trim();
  if(!v) return;
  userNick=v;
  localStorage.setItem('nick',v);
  notify('–ù–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
}

/* ===== –ü–†–û–ú–û–ö–û–î–´ ===== */
function applyPromo(){
  const code=document.getElementById('promoInput').value.trim();
  if(!code) return notify("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥!");
  const promoCodes={ "Hakka":25, "Arabchik":25 };
  let coins=parseInt(document.getElementById('coins').textContent)||0;
  if(promoCodes[code]){
    coins+=promoCodes[code];
    document.getElementById('coins').textContent=coins;
    localStorage.setItem('coins',coins);
    notify(`–ü—Ä–æ–º–æ–∫–æ–¥ ${code} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! +${promoCodes[code]} Retokens`);
    document.getElementById('promoInput').value='';
  } else notify("–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥!");
}

/* ===== –ü–ï–†–°–û–ù–ê–ñ–ò ===== */
const officialChars={'–†–∏–∞—Å':{avatar:'https://i.imgur.com/AkFUZMB.png',theme:'rias'},'–ö–æ–Ω—ç–∫–æ':{avatar:'https://i.imgur.com/fh2s0yw.png',theme:'koneko'}};

/* ===== –ß–ê–¢ ===== */
const chat=document.getElementById('chat');
function addWithAvatar(text,cls,avatar){
  const d=document.createElement('div');
  d.className='msg '+cls;
  const av=document.createElement('div'); av.className='avatar'; av.style.backgroundImage=`url(${avatar})`;
  d.appendChild(av);
  const txt=document.createElement('div'); txt.innerHTML=text;
  d.appendChild(txt);
  chat.appendChild(d); chat.scrollTop=chat.scrollHeight;
}

function openChat(name){
  currentChar=name;
  document.getElementById('header').textContent='Hakka AI ‚Äî '+name;
  chat.innerHTML='';
  let data=officialChars[name]||JSON.parse(localStorage.getItem('userCharacter'));
  if(!data)data={avatar:'https://i.imgur.com/AkFUZMB.png',theme:'rias'};
  chat.dataset.avatar=data.avatar;
  setAtmosphere(data.theme);
  show('chatScreen');
}

function send(){
  const t = document.getElementById('msg').value.trim();
  if(!t) return;
  document.getElementById('msg').value = '';
  addWithAvatar(t, 'user', tgUser.photo_url);

  const typing = document.createElement('div');
  typing.className = 'msg bot typing';
  typing.textContent = currentChar + ' –ø–µ—á–∞—Ç–∞–µ—Ç...';
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;

  // ======= –õ–û–ö–ê–õ–¨–ù–´–ô HAKKA AI =======
  fetch("https://–¢–í–û–ô_NGROK_URL/chat", { // <-- –í–°–¢–ê–í–¨ –°–í–û–ô NGROK URL
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      message: t,
      user: userNick
    })
  })
  .then(res => res.json())
  .then(data => {
    typing.remove();
    const avatar = (officialChars[currentChar]?.avatar) || (JSON.parse(localStorage.getItem('userCharacter'))?.avatar) || 'https://i.imgur.com/AkFUZMB.png';
    addWithAvatar(data.reply, 'bot', avatar);
  })
  .catch(err => {
    typing.remove();
    addWithAvatar(`<i>–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –ò–ò</i>`, 'bot', 'https://i.imgur.com/AkFUZMB.png');
    console.error(err);
  });
}

/* ===== –ê–¢–ú–û–°–§–ï–†–ê ===== */
function setAtmosphere(t){
  if(t==='koneko'){ document.documentElement.style.setProperty('--bg','#0e1a22'); document.documentElement.style.setProperty('--accent','#bfefff'); }
  else if(t==='rias'){ document.documentElement.style.setProperty('--bg','#140c12'); document.documentElement.style.setProperty('--accent','#ff4d6d'); }
  else{ document.documentElement.style.setProperty('--bg','#2a1018'); document.documentElement.style.setProperty('--accent','#ff99aa'); }
}

/* ===== –§–û–ù: –∑–≤–µ–∑–¥–æ—á–∫–∏ ===== */
const sparkles=[]; let tx=0,ty=0,mx=0,my=0;
for(let i=0;i<50;i++){ const s=document.createElement('div'); s.className='sparkle'; const z=Math.random()*3+2; s.style.width=z+'px'; s.style.height=z+'px'; s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%'; document.body.appendChild(s); sparkles.push({el:s,base:Math.random()*20}); }
function animate(){ mx+=(tx-mx)*.05; my+=(ty-my)*.05; const t=Date.now()/1000; sparkles.forEach((s,i)=>{ s.el.style.transform=`translate(${Math.sin(t+i)*s.base+mx*20}px,${Math.cos(t+i)*s.base+my*20}px)`; }); requestAnimationFrame(animate); }
animate();
document.addEventListener('mousemove',e=>{tx=e.clientX/window.innerWidth-.5; ty=e.clientY/window.innerHeight-.5;});
document.addEventListener('touchmove',e=>{const t=e.touches[0]; tx=t.clientX/window.innerWidth-.5; ty=e.touches[0].clientY/window.innerHeight-.5;});

/* ===== –ú–ê–°–¢–ï–†–°–ö–ê–Ø ===== */
const previewAvatar=document.getElementById('previewAvatar');
const previewName=document.getElementById('previewName');
const previewMood=document.getElementById('previewMood');
document.getElementById('charName').addEventListener('input',()=>{previewName.textContent=document.getElementById('charName').value||'–ò–º—è';});
document.getElementById('charMood').addEventListener('input',()=>{previewMood.textContent=document.getElementById('charMood').value||'–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ';});
document.getElementById('charAvatar').addEventListener('input',()=>{const url=document.getElementById('charAvatar').value; previewAvatar.style.backgroundImage=url?`url(${url})`:'';});

function createCharacter(){
  const name=document.getElementById('charName').value.trim();
  const mood=document.getElementById('charMood').value.trim()||'—Ç–µ–ø–ª—ã–π';
  const avatar=document.getElementById('charAvatar').value.trim()||'https://i.imgur.com/AkFUZMB.png';
  if(!name) return notify("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!");
  let coins=parseInt(document.getElementById('coins').textContent);
  if(coins<100) return notify("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Retokens!");
  document.getElementById('coins').textContent=coins-100;
  localStorage.setItem('coins',coins-100);
  const userChar={name,mood,avatar};
  localStorage.setItem('userCharacter',JSON.stringify(userChar));
  notify(`–ü–µ—Ä—Å–æ–Ω–∞–∂ ${name} —Å–æ–∑–¥–∞–Ω! 100 Retokens –ø–æ—Ç—Ä–∞—á–µ–Ω–æ!`);
}

function openUserChar(){
  const data=JSON.parse(localStorage.getItem('userCharacter'));
  if(!data) return notify("–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–≤–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.");
  currentChar=data.name;
  document.getElementById('header').textContent='Hakka AI ‚Äî '+data.name;
  setAtmosphere('user');
  chat.innerHTML='';
  show('chatScreen');
}
</script>
</body>
</html>
