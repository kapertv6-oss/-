<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>HAKKA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg:#0b0d14;
  --neon:#ff4d6d;
  --text:#f2f2f2;
  --card1:#161a2a;
  --card2:#0f1220;
  --dx-color:#ff8c00;
  --hellsing-color:#8a2be2;
  --spy-color:#00ced1;
  --user-color:#ff69b4;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:Segoe UI,sans-serif;
  background:radial-gradient(circle at top,#14182a,var(--bg));
  color:var(--text);
  min-height:100vh;
  overflow-y:auto;
}
body::-webkit-scrollbar{width:8px;}
body::-webkit-scrollbar-thumb{background:var(--neon);border-radius:8px;}
.app{max-width:420px;margin:auto;padding:16px;}
.screen{display:none;animation:fade .3s ease;}
.screen.active{display:block;}
@keyframes fade{from{opacity:0;transform:translateY(8px);}to{opacity:1;}}
.title{text-align:center;font-size:24px;font-weight:700;color:var(--neon);margin-bottom:16px;}

.card{
  background:linear-gradient(180deg,var(--card1),var(--card2));
  border-radius:16px;
  padding:14px;
  margin-bottom:14px;
  transition:.3s;
}
.card:hover{transform:translateY(-2px);box-shadow:0 0 16px rgba(255,77,109,.4);}

button{
  background:var(--neon);
  border:none;
  color:white;
  padding:10px;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  width:100%;
  margin-top:8px;
}

input,textarea{
  width:100%;
  margin-top:8px;
  padding:10px;
  border-radius:12px;
  border:none;
  background:#161a2a;
  color:white;
}
textarea{resize:none;height:70px}

.characters-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.avatar{
  width:60px;height:60px;border-radius:50%;
  background-size:cover;background-position:center;
  border:2px solid var(--neon);
  margin:0 auto 6px;
}

.chat-message{
  padding:6px 10px;
  border-radius:12px;
  max-width:80%;
  margin-bottom:6px;
  word-wrap:break-word;
}
.user-msg{align-self:flex-end;background:var(--neon);}
.bot-msg{align-self:flex-start;background:#161a2a;border:1px solid var(--neon);}
.cursor{color:var(--neon);font-weight:bold;}

@media(max-width:420px){
  .characters-grid{grid-template-columns:1fr;}
}
</style>
</head>

<body>
<div class="app">

<!-- ===== –ú–ï–ù–Æ ===== -->
<div id="menu" class="screen active">
  <h1 class="title">HAKKA</h1>
  <button onclick="openCharacters()">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</button>
  <button onclick="openWorkshop()">–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è</button>
</div>

<!-- ===== –ü–ï–†–°–û–ù–ê–ñ–ò ===== -->
<div id="characters" class="screen">
  <h1 class="title">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h1>
  <div id="charactersGrid" class="characters-grid"></div>
  <button onclick="goMenu()">–ù–∞–∑–∞–¥</button>
</div>

<!-- ===== –ú–ê–°–¢–ï–†–°–ö–ê–Ø ===== -->
<div id="workshop" class="screen">
  <h1 class="title">–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è</h1>

  <div class="card">
    <strong>–°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</strong>
    <input id="charName" placeholder="–ò–º—è">
    <textarea id="charDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
    <input id="charAvatar" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∞">
    <button onclick="createCharacter()">–°–æ–∑–¥–∞—Ç—å</button>
  </div>

  <div class="card">
    <strong style="color:var(--neon)">üöß –°–∫–æ—Ä–æ</strong>
    <p style="opacity:.85">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
  </div>

  <button onclick="goMenu()">–ù–∞–∑–∞–¥</button>
</div>

<!-- ===== –ß–ê–¢ ===== -->
<div id="chat" class="screen">
  <h1 class="title" id="chatTitle"></h1>
  <div id="chatWindow" style="display:flex;flex-direction:column;"></div>
  <input id="userMessage" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
  <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  <button onclick="goCharacters()">–ù–∞–∑–∞–¥</button>
</div>

</div>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const API = "https://shelba-hardenable-bell.ngrok-free.dev";

/* ===== –ö–ê–ù–û–ù –ü–ï–†–°–û–ù–ê–ñ–ï–ô (–¢–í–û–ò) ===== */
const canonChars = [
 {name:"–ê–ª—É–∫–∞—Ä–¥",desc:"–î—Ä–µ–≤–Ω–∏–π –±–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π –≤–∞–º–ø–∏—Ä.",avatar:"https://i.pinimg.com/736x/ed/ba/36/edba369f339eb95915ea915a8b48eb2e.jpg"},
 {name:"–†–∏–∞—Å –ì—Ä–µ–º–æ—Ä–∏",desc:"–•–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω–∞—è –¥–µ–º–æ–Ω–µ—Å—Å–∞.",avatar:"https://zefirka.club/uploads/posts/2022-09/1662219894_4-zefirka-club-p-rias-gremori-na-avu-5.jpg"}
];

const profile = JSON.parse(localStorage.getItem("hakkaProfile")) || {nick:"–ò–≥—Ä–æ–∫"};
let activeChar=null;

/* ===== –ü–ï–†–°–û–ù–ê–ñ–ò ===== */
function openCharacters(){
 showScreen("characters");
 renderCharacters();
}

function renderCharacters(){
 const grid=document.getElementById("charactersGrid");
 grid.innerHTML="";

 canonChars.forEach(c=>renderCard(c));

 fetch(API+"/character/list/"+profile.nick)
   .then(r=>r.json())
   .then(list=>list.forEach(c=>renderCard(c)));
}

function renderCard(c){
 const div=document.createElement("div");
 div.className="card";
 div.innerHTML=`
  <div class="avatar" style="background-image:url('${c.avatar}')"></div>
  <strong>${c.name}</strong>
  <p style="opacity:.8">${c.desc}</p>
  <button onclick="openChat('${c.name}')">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</button>
 `;
 charactersGrid.appendChild(div);
}

/* ===== –ß–ê–¢ ===== */
function openChat(name){
 activeChar=name;
 showScreen("chat");
 chatTitle.textContent="–ß–∞—Ç —Å "+name;
 loadChat();
}

function sendMessage(){
 const msg=userMessage.value.trim();
 if(!msg)return;

 addMsg("user",msg);
 saveMsg("user",msg);

 fetch(API+"/ask",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({message:msg,character:activeChar})
 })
 .then(r=>r.json())
 .then(d=>{
  typeBotMessage(d.answer);
  saveMsg("bot",d.answer);
 });

 userMessage.value="";
}

function addMsg(type,text){
 const div=document.createElement("div");
 div.className="chat-message "+(type==="user"?"user-msg":"bot-msg");
 div.textContent=text;
 chatWindow.appendChild(div);
 chatWindow.scrollTop=chatWindow.scrollHeight;
}

function typeBotMessage(text){
 const block=document.createElement("div");
 block.className="chat-message bot-msg";
 const span=document.createElement("span");
 const cursor=document.createElement("span");
 cursor.className="cursor";cursor.textContent="|";
 block.append(span,cursor);
 chatWindow.appendChild(block);

 let i=0;
 (function type(){
  if(i<text.length){
   span.textContent+=text[i++];
   chatWindow.scrollTop=chatWindow.scrollHeight;
   setTimeout(type,30);
  }else cursor.remove();
 })();
}

/* ===== –°–ï–†–í–ï–† ===== */
function saveMsg(sender,msg){
 fetch(API+"/chat/save",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
   user:profile.nick,
   character:activeChar,
   sender,
   message:msg
  })
 });
}

function loadChat(){
 fetch(`${API}/chat/load?user=${profile.nick}&character=${activeChar}`)
 .then(r=>r.json())
 .then(list=>{
  chatWindow.innerHTML="";
  list.forEach(m=>addMsg(m.sender,m.msg));
 });
}

/* ===== –ú–ê–°–¢–ï–†–°–ö–ê–Ø ===== */
function openWorkshop(){showScreen("workshop");}

function createCharacter(){
 fetch(API+"/character/create",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
   user:profile.nick,
   name:charName.value,
   description:charDesc.value,
   avatar:charAvatar.value
  })
 }).then(()=>alert("–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ–∑–¥–∞–Ω!"));
}

/* ===== –£–¢–ò–õ–ò–¢–´ ===== */
function showScreen(id){
 document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}
function goMenu(){showScreen("menu");}
function goCharacters(){showScreen("characters");}
</script>

</body>
</html>

